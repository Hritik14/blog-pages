<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  
    <title>Booting the Linux kernel inside QEMU with custom initramfs :: </title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Shivering in this cold winter one would certainly stumble upon the question that the Linux Kernel, which operates most of your operating system, is just a huge C program.
Shouldn&rsquo;t it, then, be possible to compile and run it as you do to all your C programs ?
" />
<meta name="keywords" content="kernel, boot, qemu, linux is kernel, OS, Operating System" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="http://localhost:1313/posts/linux-boot/" />






  
  
  
  
  
  <link rel="stylesheet" href="http://localhost:1313/styles.css">



<link rel="stylesheet" href="http://localhost:1313/style.css">



  <link rel="shortcut icon" href="http://localhost:1313/favicon.png">



<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="https://hritik.sh" />
  
    <meta name="twitter:creator" content="" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Booting the Linux kernel inside QEMU with custom initramfs">
<meta property="og:description" content="Shivering in this cold winter one would certainly stumble upon the question that the Linux Kernel, which operates most of your operating system, is just a huge C program.
Shouldn&rsquo;t it, then, be possible to compile and run it as you do to all your C programs ?
" />
<meta property="og:url" content="http://localhost:1313/posts/linux-boot/" />
<meta property="og:site_name" content="" />

  
    <meta property="og:image" content="http://localhost:1313/favicon.png">
  

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2020-12-18 00:00:00 &#43;0000 UTC" />












</head>
<body class="green">


<div class="container full">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Hritik&#39;s Blog
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;▾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="/ctf-writeups">Writeups</a></li>
        
      
        
          <li><a href="https://github.com/hritik14">Github</a></li>
        
      
        
          <li><a href="/index.xml">RSS</a></li>
        
      
        
          <li><a href="/cheatsheets">Cheatsheets</a></li>
        
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="mailto:ping@hritik.sh">Contact</a></li>
        
      
        
          <li><a href="https://www.linkedin.com/in/hritikvijay/">LinkedIn</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="/ctf-writeups" >Writeups</a></li>
        
      
        
          <li><a href="https://github.com/hritik14" >Github</a></li>
        
      
        
          <li><a href="/index.xml" >RSS</a></li>
        
      
      
        <li>
          <ul class="menu">
            <li class="menu__trigger">Show more&nbsp;▾</li>
            <li>
              <ul class="menu__dropdown">
                
                  
                    <li><a href="/cheatsheets" >Cheatsheets</a></li>
                  
                
                  
                    <li><a href="/about" >About</a></li>
                  
                
                  
                    <li><a href="mailto:ping@hritik.sh" >Contact</a></li>
                  
                
                  
                    <li><a href="https://www.linkedin.com/in/hritikvijay/" >LinkedIn</a></li>
                  
                
              </ul>
            </li>
          </ul>
        </li>
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="http://localhost:1313/posts/linux-boot/">Booting the Linux kernel inside QEMU with custom initramfs</a>
  </h1>
  <div class="post-meta"><time class="post-date">2020-12-18</time></div>

  
  


  

  <div class="post-content"><div>
        <p>Shivering in this cold winter one would certainly stumble upon the question that the Linux Kernel, which operates most of your operating system, is just a huge C program.<br>
Shouldn&rsquo;t it, then, be possible to compile and run it as you do to all your C programs ?</p>
<p>Here, I&rsquo;d be using the famous <a href="https://www.qemu.org">qemu</a> emulator to run a pre compiled linux kernel. So, let&rsquo;s begin.</p>
<h2 id="theory">Theory<a href="#theory" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>We all hate this part but it deserves its position.<br>
Here&rsquo;s how a typical linux boot works after the kernel is loaded.<br>
The kernel initializes and looks for an <code>initramfs</code>. This is a temporary root filesystem. Now, the kernel doesn&rsquo;t know if your real root is residing on a USB stick or a hard disk or RAID or god-knows-what. It cannot support everything, so it&rsquo;s the job of initramfs to store the <a href="https://en.wikipedia.org/wiki/Loadable_kernel_module">loadable kernel modules</a> and assist the kernel. In short, it complements the kernel.<br>
After the Kernel has initialized keyboard, mouse etc, now it&rsquo;s the time to mount your hard disk (or say, the root filesystem) and then present you the fancy login screen where you can carry on with your journey.</p>
<h2 id="get-your-tools">Get your tools<a href="#get-your-tools" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<ul>
<li><a href="https://www.qemu.org">QEMU</a></li>
<li>The Kernel</li>
<li>fakeroot</li>
</ul>
<h2 id="the-kernel">The Kernel<a href="#the-kernel" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>You can find a pre-compiled kernel at <code>/boot/vmlinuz-linux</code></p>
<h2 id="initramfs">Initramfs<a href="#initramfs" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>We&rsquo;d be creating this one. The tool at our disposal is <code>mkinitcpio</code></p>
<p>Step zero would be to enter into the <code>fakeroot</code> environment. It makes you appear as root but you&rsquo;re not. This is required to make a proper initramfs.</p>
<pre class="language-shell"><code>$ fakeroot</code></pre><p>then create a config file named <code>mkinitcpio.conf</code> with the following contents:</p>
<pre class="language-bash"><code>MODULES=(ext4)
HOOKS=(base systemd modconf sd-vconsole filesystems block keyboard)</code></pre><p>and the last step is to generate the initramfs</p>
<pre class="language-shell"><code>$ mkinitcpio -k /boot/vmlinuz-linux -c /etc/mkinitcpio.conf -g initramfs.img</code></pre><p>Now, you have the initramfs in a file named <code>initramfs.img</code>.</p>
<p>You can now safely exit the fakeroot environent by typing <code>exit</code>.</p>
<h2 id="boot-the-kernel-using-qemu">Boot the kernel using QEMU<a href="#boot-the-kernel-using-qemu" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>After you have your hands on a compiled kernel and initramfs, you&rsquo;d be eager to boot it in a live environment. We can simulate the same using QEMU.</p>
<p>Looking at <code>man qemu</code>, here are some interesting options</p>
<pre class="language-man"><code>	-kernel bzImage
	Use bzImage as kernel image. The kernel can be either a Linux kernel or in multiboot for‐
	mat.  

   -append cmdline
		  Use cmdline as kernel command line

   -initrd file
		  Use file as initial ram disk.  </code></pre><p>Cool, we&rsquo;ve a kernel image, an initramfs, so why wait ? Let&rsquo;s boot right in.</p>
<pre class="language-shell"><code>$ qemu-system-x86_64 -kernel vmlinuz-linux -initrd initramfs.img</code></pre><p>To your surprise, it yields:</p>
<p><img src="/images/linux-boot/no-ram.jpg" alt="no-ram"></p>
<p>The Kernel <em>panicked</em>. It typically happens when you try to boot without a RAM.<br>
So, let&rsquo;s try adding a 1G of RAM.</p>
<pre class="language-shell"><code>$ qemu-system-x86_64 -kernel vmlinuz-linux -initrd initramfs.img -m 1G</code></pre><p>Another roadblock!</p>
<p><img src="/images/linux-boot/no-hdd.jpg" alt="no-hdd"></p>
<p>Now, the kernel and the initramfs were done but you&rsquo;d need a hard disk where everything should carry on i.e. the Operating System.</p>
<h2 id="add-a-hard-disk">Add a hard disk<a href="#add-a-hard-disk" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>First, we&rsquo;d be creating a <a href="https://en.wikipedia.org/wiki/Sparse_file">sparse file</a> of 2GB</p>
<pre class="language-shell"><code>$ dd if=/dev/zero of=kernel-hd bs=1M count=2048
2048&#43;0 records in
2048&#43;0 records out
2147483648 bytes (2.1 GB, 2.0 GiB) copied, 9.87468 s, 217 MB/s</code></pre><p>Now, a hard disk in itself isn&rsquo;t enough. You&rsquo;d need a filesystem (typically called <em>formatting the hard disk</em>). Let&rsquo;s create one.</p>
<pre class="language-shell"><code>$ mkfs.ext4 kernel-hd
mke2fs 1.45.6 (20-Mar-2020)
Discarding device blocks: done
Creating filesystem with 524288 4k blocks and 131072 inodes
Filesystem UUID: 3654d72f-3f6d-4d90-8848-2900d7c271d0
Superblock backups stored on blocks:
	32768, 98304, 163840, 229376, 294912

Allocating group tables: done
Writing inode tables: done
Creating journal (16384 blocks): done
Writing superblocks and filesystem accounting information: done</code></pre><p>We&rsquo;ve successfully created a filesystem in the virtual hard disk. Yay!</p>
<h2 id="boot-the-kernel-with-the-hard-disk">Boot the kernel with the hard disk<a href="#boot-the-kernel-with-the-hard-disk" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Now, we&rsquo;ve everything set up. The only task at hand is to plug in the newly created hard disk to a QEMU VM and instruct the kernel to treat that hard disk as the <em>new_root</em>.</p>
<pre class="language-shell"><code>$ qemu-system-x86_64 -kernel vmlinuz-linux -initrd initramfs.img -m 1G -hda kernel-hd -append &#34;root=/dev/sda&#34;</code></pre><p><img src="/images/linux-boot/no-hdd2.jpg" alt="no-hdd2">
Wait, what !?</p>
<p>Hmm, something is not quite right.<br>
It turns out the kernel cannot continue to boot without some basic files (the OS) in the root filesystem (the hard disk)</p>
<h2 id="populating-the-hard-disk">Populating the Hard Disk<a href="#populating-the-hard-disk" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>There are plently of ways you can find or generate the required files (say, a kernel-less Operating System). Here we&rsquo;ll use the packages provided by Arch.<br>
Feel free to experiment about this.</p>
<p>Install <code>pacstrap</code> by</p>
<pre class="language-shell"><code>$ sudo pacman -S arch-install-scripts</code></pre><p>Now mount the <code>kernel-hd</code> at <code>/mnt</code></p>
<pre class="language-shell"><code>$ sudo mount kernel-hd /mnt</code></pre><p>And populate the hard disk with Arch&rsquo;s base packages.</p>
<pre class="language-shell"><code>$ sudo pacstrap /mnt base</code></pre><p>This will start a download of around 115MB. Note, that after this step, you <em>should</em> update your host Arch system soon. (<code>pacman -Syu</code>)</p>
<p>The OS is ready but you&rsquo;re gonna need some login credentials to log in.<br>
Set a root password in your little OS that you&rsquo;ve just created.</p>
<pre class="language-shell"><code>$ sudo passwd --root /mnt root</code></pre><p>And finally unmount <code>kernel-hd</code></p>
<pre class="language-shell"><code>$ sudo umount kernel-hd</code></pre><h2 id="boot-our-handcrafted-system">Boot our handcrafted system<a href="#boot-our-handcrafted-system" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Rerun the following command</p>
<pre class="language-shell"><code>$ qemu-system-x86_64 -kernel vmlinuz-linux -initrd initramfs.img -m 1G -hda kernel-hd -append &#34;root=/dev/sda&#34;</code></pre><p>and finally you&rsquo;ll be greeted with</p>
<p><img src="/images/linux-boot/login-screen.jpg" alt="login-screen"></p>
<p>Login with the credentials you set before and enjoy!</p>
<h1 id="wth-">WTH ?<a href="#wth-" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<h2 id="root-account-is-locked">Root account is locked<a href="#root-account-is-locked" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>If something goes wrong in the initramfs phase and you see <code>root account is locked</code>, you can unlock the root account by creating a <code>mkinitcpio.conf</code> file as follows:</p>
<pre class="language-bash"><code># Required
MODULES=(ext4)
HOOKS=(base systemd modconf sd-vconsole filesystems block keyboard)

# Unlocking the root account
echo &#39;root:x:0:0:root:/root:/bin/sh&#39; &gt; /tmp/passwd
echo &#39;root:$6$drlHj0v2/B7liRyL$YH0ZHsG4d05mS6moBPkdzI5dlt9RjrPbWTCwDk7r5ZCWIGHFEx9A/atj/hPImYPq7qGzi8zGHOKqRgfHSfq7b/:18611:0:99999:7:::&#39; &gt; /tmp/shadow
add_file /tmp/passwd /etc/passwd 0644
add_file /tmp/shadow /etc/shadow 0600</code></pre><p>and then regenerating the <code>initramfs.img</code> as shown before.<br>
Remember to enter the <code>fakeroot</code> environment before generating the <code>initramfs.img</code>.
This will enable you to login with the password <code>12345678</code></p>
<h2 id="why-not-use-the-default-bootinitramfs-linuximg">Why not use the default /boot/initramfs-linux.img<a href="#why-not-use-the-default-bootinitramfs-linuximg" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>We have been using the same kernel that your host is using, located at <code>/boot/vmlinuz-linux</code>. So, it might sound better to use the host initramfs as well.<br>
Theoretically, you should be able to just copy and use that but for reasons I&rsquo;ve faced and bashed my head over multiple times, I&rsquo;d recommend generating your own initramfs.</p>
<h2 id="waiting-for-devsda-or-devsda-not-detected">Waiting for /dev/sda&hellip; or /dev/sda not detected<a href="#waiting-for-devsda-or-devsda-not-detected" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>It might be a qemu issue. You can try emulating SATA as mentioned <a href="sata">here</a>.<br>
Basically, you&rsquo;d need to drop the <code>-hda kernel-hd</code> flag and use the one mentioned in the answer.<br>
Thanks to <code>sheep</code> from freenode IRC for the suggestion.</p>
<h2 id="why-arch-">Why Arch ?<a href="#why-arch-" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Because it&rsquo;s the best. Feel free to write your own OS files. Maybe another time.</p>
<h2 id="still-dont-want-arch">Still don&rsquo;t want Arch<a href="#still-dont-want-arch" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Sure, you should head into <a href="http://www.linuxfromscratch.org/lfs/">Linux From Scratch</a>. Also, you may <a href="/posts/linux-boot/#root-account-is-locked">unlock the root account</a> and use <code>journalctl</code> to look into what the kernel is error-ing for.</p>
<h2 id="dont-want-an-os-at-all">Don&rsquo;t want an OS at all<a href="#dont-want-an-os-at-all" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>First, <a href="/posts/linux-boot/#root-account-is-locked">unlock the root account</a> and don&rsquo;t create a Hard Disk at all. You&rsquo;d be able to log into the initramfs after boot. Explore, enjoy.</p>
<h1 id="afterwords">Afterwords<a href="#afterwords" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>Now you know that Linux itself is <strong>not</strong> an operating system. It&rsquo;s just a kernel. A part of the operating system. The entire operating system (or distro) consists of the kernel, accompanying initramfs, the root file system and the community.</p>

      </div></div>

  
    
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="http://localhost:1313/posts/driver-loading-and-binding/">
                <span class="button__icon">←</span>
                <span class="button__text">Loading and probing of USB device drivers</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="http://localhost:1313/posts/secarmy-unintended-ctf/">
                <span class="button__text">Grayhat -&gt; Secarmy CTF :: The Unintended Way</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2025 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
