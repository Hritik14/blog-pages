<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Loading and probing of USB device drivers :: </title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="The Linux USB driver expects a probe function which is called when a matching device is plugged in.
When a device is plugged into the USB bus that matches the device ID pattern that your driver registered with the USB core, the probe function is called.
" />
<meta name="keywords" content="kernel, hotplugging, hotplug, usb, driver, probe, module_init" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="https://hritik.sh/posts/driver-loading-and-binding/" />






  
  
  
  
  
  <link rel="stylesheet" href="https://hritik.sh/styles.css">



<link rel="stylesheet" href="https://hritik.sh/style.css">



  <link rel="shortcut icon" href="https://hritik.sh/favicon.png">



<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="https://hritik.sh" />
  
    <meta name="twitter:creator" content="" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Loading and probing of USB device drivers">
<meta property="og:description" content="The Linux USB driver expects a probe function which is called when a matching device is plugged in.
When a device is plugged into the USB bus that matches the device ID pattern that your driver registered with the USB core, the probe function is called.
" />
<meta property="og:url" content="https://hritik.sh/posts/driver-loading-and-binding/" />
<meta property="og:site_name" content="" />

  
    <meta property="og:image" content="https://hritik.sh/favicon.png">
  

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2021-05-17 00:00:00 &#43;0000 UTC" />












</head>
<body class="green">


<div class="container full">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    Hritik&#39;s Blog
  </div>
</a>

    </div>
    
      <ul class="menu menu--mobile">
  <li class="menu__trigger">Menu&nbsp;▾</li>
  <li>
    <ul class="menu__dropdown">
      
        
          <li><a href="/ctf-writeups">Writeups</a></li>
        
      
        
          <li><a href="https://github.com/hritik14">Github</a></li>
        
      
        
          <li><a href="/index.xml">RSS</a></li>
        
      
        
          <li><a href="/cheatsheets">Cheatsheets</a></li>
        
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="mailto:ping@hritik.sh">Contact</a></li>
        
      
        
          <li><a href="https://www.linkedin.com/in/hritikvijay/">LinkedIn</a></li>
        
      
      
    </ul>
  </li>
</ul>

    
    
  </div>
  
    <nav class="navigation-menu">
  <ul class="navigation-menu__inner menu--desktop">
    
      
        
          <li><a href="/ctf-writeups" >Writeups</a></li>
        
      
        
          <li><a href="https://github.com/hritik14" >Github</a></li>
        
      
        
          <li><a href="/index.xml" >RSS</a></li>
        
      
      
        <li>
          <ul class="menu">
            <li class="menu__trigger">Show more&nbsp;▾</li>
            <li>
              <ul class="menu__dropdown">
                
                  
                    <li><a href="/cheatsheets" >Cheatsheets</a></li>
                  
                
                  
                    <li><a href="/about" >About</a></li>
                  
                
                  
                    <li><a href="mailto:ping@hritik.sh" >Contact</a></li>
                  
                
                  
                    <li><a href="https://www.linkedin.com/in/hritikvijay/" >LinkedIn</a></li>
                  
                
              </ul>
            </li>
          </ul>
        </li>
      
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="https://hritik.sh/posts/driver-loading-and-binding/">Loading and probing of USB device drivers</a>
  </h1>
  <div class="post-meta"><time class="post-date">2021-05-17</time></div>

  
  


  

  <div class="post-content"><div>
        <p>The Linux USB driver expects a <a href="https://www.kernel.org/doc/html/v4.12/driver-api/usb/usb.html#c.usb_driver">probe function</a> which is called when a matching device is plugged in.</p>
<blockquote>
<p>When a device is plugged into the USB bus that matches the device ID pattern that your driver registered with the USB core, the probe function is called.</p>
<ul>
<li><a href="https://www.kernel.org/doc/html/v4.12/driver-api/usb/writing_usb_driver.html#device-operation">Device operation</a></li>
</ul></blockquote>
<p>Following are some questions that have appeared on the internet <a href="https://lists.kernelnewbies.org/pipermail/kernelnewbies/2011-October/003639.html">time</a> and again<a href="https://stackoverflow.com/questions/31052993/why-is-the-probe-function-in-my-kernel-module-not-being-called">6</a>.</p>
<h3 id="when-will-probe-function-be-called-">When will probe function be called ?<a href="#when-will-probe-function-be-called-" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>When a matching entry registered in MODULE_DEVICE_TABLE is found for the device.</p>
<h3 id="if-there-are-two-matches-to-module_device_table-would-both-probes-be-called-">If there are two matches to MODULE_DEVICE_TABLE, would both probes be called ?<a href="#if-there-are-two-matches-to-module_device_table-would-both-probes-be-called-" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>No, only the one which binds to the device successfully.</p>
<h3 id="would-all-the-modules-always-be-loaded-if-they-contain-a-matching-entry-in-module_device_table-">Would <strong>all</strong> the modules always be loaded if they contain a matching entry in MODULE_DEVICE_TABLE ?<a href="#would-all-the-modules-always-be-loaded-if-they-contain-a-matching-entry-in-module_device_table-" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>By loading, call to <code>module_init</code> is reffered.<br>
Considering the case of udev, it&rsquo;s the <a href="https://unix.stackexchange.com/a/417004/154333">responsibility of udev</a> to load kernel modules. The following confirms it:</p>
<blockquote>
<p>Device drivers compiled as modules may have aliases built into them. Aliases are visible in the output of the modinfo program and are usually related to the bus-specific identifiers of devices supported by a module.<br>
For example, the snd-fm801 driver supports PCI devices with vendor ID 0x1319 and device ID 0x0801, and has an alias of “pci:v00001319d00000801sv<em>sd</em>bc04sc01i*”. For most devices, the bus driver exports the alias of the driver that would handle the device via sysfs. E.g., the /sys/bus/pci/devices/0000:00:0d.0/modalias file might contain the string “pci:v00001319d00000801sv00001319sd00001319bc04sc01i00”.<br>
The default rules provided with udev will cause udevd to call out to /sbin/modprobe with the contents of the MODALIAS uevent environment variable (which should be the same as the contents of the modalias file in sysfs), thus loading all modules whose aliases match this string after wildcard expansion</p>
<ul>
<li><a href="https://www.linuxfromscratch.org/lfs/view/development/chapter09/udev.html">9.3.2.3. Module Loading</a></li>
</ul></blockquote>
<!--
The same doc goes on to say 
>  The kernel itself is also able to load modules for network protocols, filesystems, and NLS support on demand. 

But we'll skip that part for now.
-->
<p>Notice the last line, <em>&ldquo;thus loading all modules whose aliases match this string after wildcard expansion&rdquo;</em>. So yes! All modules will be loaded.</p>
<h3 id="my-module_init-was-called-by-probe-was-not">My module_init() was called by probe was not<a href="#my-module_init-was-called-by-probe-was-not" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>See above</p>
<!--
### [This document][1] says the following, how can I find the source code for it ?
> Find a driver that can handle the device. That may involve loading a kernel module.
It goes on to say that a "USB Policy Agent" is responsible to load drivers for modules.
Currently it is done by [module-init-tools][2]

After cloning the repo, readme says
> NOTE: module-init-tools is due to be replaced with a new utility, which will
>     be based upon the "libkmod" (kmod) codebase, unified with this one. To
phew

If you go on to find the linkage between kmod and udev, mail me at hr1t1k at protonmail dot com
-->
<h3 id="udev-accesses-same-info-in-order-to-figure-out-the-device-driver-pair-is-that-table-accessible-by-any-userland-program--where">Udev accesses same info in order to figure out the device, driver pair. Is that table accessible by any userland program ? Where?<a href="#udev-accesses-same-info-in-order-to-figure-out-the-device-driver-pair-is-that-table-accessible-by-any-userland-program--where" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<pre class="language-bash"><code>modinfo module_name</code></pre><p>The <code>alias</code> is matched against the device.</p>
<h3 id="in-what-order-will-the-kernel-decide-to-give-opportunities-to-device-drivers-to-bind-to-a-device-">In what order will the kernel decide to give opportunities to device drivers to bind to a device ?<a href="#in-what-order-will-the-kernel-decide-to-give-opportunities-to-device-drivers-to-bind-to-a-device-" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h3>
<p>Load order is no one&rsquo;s responsibility.
Without any priority, either driver may be probed first and consequently may end up binding to the device; the
result is more or less random.
It may even differ from one boot to the next.</p>
<p>Thanks to Alan Stern from <a href="https://marc.info/?l=linux-usb&amp;m=162123892329464&amp;w=2">linux-usb mailing list</a> to clarify this to me. I highly recommend to read <a href="https://marc.info/?l=linux-usb&amp;m=162123892329464&amp;w=2">the thread</a> and look at <code>dd.c</code>, <code>bus.c</code> in <code>drivers/base</code>.</p>
<p>If you happen to find any discrepancies, do send me a <a href="/about/">note</a>.</p>

      </div></div>

  
    
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://hritik.sh/posts/go-type/">
                <span class="button__icon">←</span>
                <span class="button__text">Type conversion in go</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="https://hritik.sh/posts/linux-boot/">
                <span class="button__text">Booting the Linux kernel inside QEMU with custom initramfs</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2025 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
